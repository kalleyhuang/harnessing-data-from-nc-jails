---
title: "Harnessing Data from North Carolina's Jails to Inform Effective Policies â€” California Jail Profile Survey"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(here)
```

```{r data}
county_m <- read.csv(here("data", "california_jail_county_monthly_1995_2020.csv"))
county_m$date <- as.Date(county_m$date, format = "%Y-%m-%d")
county_m$day_of_highest_count <- as.Date(county_m$day_of_highest_count, format = "%Y-%m-%d")

county_q <- read.csv(here("data", "california_jail_county_quarterly_1995_2020.csv"))
county_q$quarter <- as.factor(county_q$quarter)

facility <- read.csv(here("data", "california_jail_facility_monthly_1995_2020.csv"))
facility$date <- as.Date(facility$date, format = "%Y-%m-%d")
facility <- facility %>% 
  rename(unsentenced_male = avg_daily_pop_unsentenced_male, 
         unsentenced_female = avg_daily_pop_unsentenced_female, 
         sentenced_male = avg_daily_pop_sentenced_male, 
         sentenced_female = avg_daily_pop_sentenced_female)
```

# Population

```{r population}
facility %>% 
  select(jurisdiction, date, unsentenced_male, unsentenced_female, sentenced_male, sentenced_female) %>% 
  group_by(jurisdiction, date) %>% 
  mutate(unsentenced_male = sum(unsentenced_male), unsentenced_female = sum(unsentenced_female),
         sentenced_male = sum(sentenced_male), sentenced_female = sum(sentenced_female)) %>% 
  unique() %>% 
  arrange(jurisdiction, date) %>% 
  mutate(pct_change_unsentenced_male = (unsentenced_male - lag(unsentenced_male)) / lag(unsentenced_male) * 100,
         pct_change_unsentenced_female = (unsentenced_female / lag(unsentenced_female) - 1) * 100,
         pct_change_sentenced_male = (sentenced_male / lag(sentenced_male) - 1) * 100,
         pct_change_sentenced_female = (sentenced_female / lag(sentenced_female) - 1) * 100)

facility %>% 
  select(date, unsentenced_male, unsentenced_female, sentenced_male, sentenced_female) %>% 
  group_by(date) %>% 
  mutate(unsentenced_male = sum(unsentenced_male), unsentenced_female = sum(unsentenced_female),
         sentenced_male = sum(sentenced_male), sentenced_female = sum(sentenced_female)) %>% 
  unique() %>% 
  arrange(date) %>% 
  ggplot(data = ., mapping = aes(x = date, group = 1)) +
  geom_line(mapping = aes(y = sentenced_male, color = "male", linetype = "solid")) +
  geom_line(mapping = aes(y = sentenced_female, color = "female", linetype = "solid")) +
  geom_line(mapping = aes(y = unsentenced_male, color = "male", linetype = "dotted")) +
  geom_line(mapping = aes(y = unsentenced_female, color = "female", linetype = "dotted")) +
  labs(x = "Year", y = "Average Daily Populations") +
  scale_color_discrete(name = "Gender", breaks = c("male", "female"), labels = c("Male", "Female")) +
  scale_linetype_manual(name = "Sentence Type",
                        values = c("solid", "dotted"), labels = c("Sentenced", "Unsentenced")) +
  theme_classic() +
  theme(axis.text.x = element_text(color = "#000000", size = 10),
        axis.text.y = element_text(color = "#000000", size = 10))
```

# Length of Stay

```{r length_of_stay}
county_q %>% 
  filter(year > 2001) %>% 
  mutate(month = case_when(quarter == 1 ~ 1, quarter == 2 ~ 4, quarter == 3 ~ 7, quarter == 4 ~ 10),
         date = as.Date(ISOdate(year, month, "01"))) %>% 
  group_by(date) %>% 
  select(date, avg_length_stay_pretrial_release, avg_length_stay_sentnced_release) %>% 
  na.omit() %>% 
  mutate(pretrial_release = mean(avg_length_stay_pretrial_release),
         sentenced_release = mean(avg_length_stay_sentnced_release)) %>% 
  select(date, pretrial_release, sentenced_release) %>% 
  unique() %>% 
  arrange(date) %>% 
  ggplot(data = ., mapping = aes(x = date, group = 1)) +
  geom_line(mapping = aes(y = pretrial_release, linetype = "solid")) +
  geom_line(mapping = aes(y = sentenced_release, linetype = "dotted")) +
  labs(x = "Year", y = "Average Lengths of Stay") +
  scale_linetype_manual(name = "Sentence Type",
                        values = c("solid", "dotted"), labels = c("Sentenced", "Pretrial")) +
  theme_classic() +
  theme(axis.text.x = element_text(color = "#000000", size = 10),
        axis.text.y = element_text(color = "#000000", size = 10))
```