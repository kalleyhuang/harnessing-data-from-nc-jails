---
title: "Harnessing Data from North Carolina's Jails to Inform Effective Policies â€” California Jail Profile Survey"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(lubridate)
library(here)
library(shiny)
```

```{r data}
options(scipen = 999)

county_m <- read.csv(here("data", "california_jail_county_monthly_1995_2020.csv"))
county_m$date <- as.Date(county_m$date, format = "%Y-%m-%d")
county_m$day_of_highest_count <- as.Date(county_m$day_of_highest_count, format = "%Y-%m-%d")
county_m <- county_m %>% 
  rename(unsen_male = avg_daily_pop_unsentenced_male, unsen_female = avg_daily_pop_unsentenced_female,
         sen_male = avg_daily_pop_sentenced_male, sen_female = avg_daily_pop_sentenced_female,
         total = avg_daily_pop_total_jurisdiction, felony_unsen = avg_felony_inmate_unsentenced,
         felony_sen = avg_felony_inmate_sentenced, felony_total = avg_felony_inmate_total,
         misd_unsen = avg_misdemean_inmate_unsentenced, misd_sen = avg_misdemean_inmate_sentenced,
         misd_total = avg_misdemean_inmate_total, county = census_county_name) %>% 
  select(4, 5, 9:19, 22:41)

county_q <- read.csv(here("data", "california_jail_county_quarterly_1995_2020.csv"))
county_q$quarter <- as.factor(county_q$quarter)
county_q <- county_q %>% 
  rename(county = census_county_name, pretrial_release = avg_length_stay_pretrial_release, 
         sentenced_release = avg_length_stay_sentnced_release) %>% 
  mutate(month = case_when(quarter == 1 ~ 1, quarter == 2 ~ 4, quarter == 3 ~ 7, quarter == 4 ~ 10),
         date = as.Date(ISOdate(year, month, "01")))

facility <- read.csv(here("data", "california_jail_facility_monthly_1995_2020.csv"))
facility$date <- as.Date(facility$date, format = "%Y-%m-%d")
facility <- facility %>% 
  rename(unsen_male = avg_daily_pop_unsentenced_male, unsen_female = avg_daily_pop_unsentenced_female, 
         sen_male = avg_daily_pop_sentenced_male, sen_female = avg_daily_pop_sentenced_female,
         total = avg_daily_pop_total_facility, county = census_county_name)
```

# Population

```{r population_data}
population <- county_m %>% 
  select(county, date, unsen_male, unsen_female, sen_male, sen_female, total) %>% 
  group_by(county, date) %>% 
  mutate(unsen_male = sum(unsen_male), unsen_female = sum(unsen_female),
         sen_male = sum(sen_male), sen_female = sum(sen_female), total = sum(total)) %>% 
  unique() %>% 
  group_by(county) %>% 
  arrange(date, .by_group = TRUE) %>% 
  mutate(pct_change_unsen_male = (unsen_male / lag(unsen_male) - 1) * 100,
         pct_change_unsen_female = (unsen_female / lag(unsen_female) - 1) * 100,
         pct_change_sen_male = (sen_male / lag(sen_male) - 1) * 100,
         pct_change_sen_female = (sen_female / lag(sen_female) - 1) * 100,
         pct_change_total = (total / lag(total) - 1) * 100) %>% 
  filter(year(date) != 1995 & year(date) != 1996 & year(date) != 2020 & 
           is.finite(pct_change_unsen_male) & is.finite(pct_change_unsen_female) &
           is.finite(pct_change_sen_male) & is.finite(pct_change_sen_female) & is.finite(total))
```

```{r population_analysis}
population_one_yr <- county_m %>% 
  filter(year(date) == 2011 | year(date) == 2012, month(date) == 1) %>%
  select(date, county, total) %>% 
  arrange(date) %>% 
  group_by(county, date) %>%
  mutate(total = sum(total)) %>% 
  unique() %>% 
  group_by(county) %>% 
  mutate(change = (total / lag(total) - 1) * 100) %>% 
  filter(year(date) == 2012)

population_three_yr <- county_m %>% 
  filter(year(date) == 2011 | year(date) == 2014, month(date) == 1) %>%
  select(date, county, total) %>% 
  arrange(date) %>% 
  group_by(county, date) %>%
  mutate(total = sum(total)) %>% 
  unique() %>% 
  group_by(county) %>% 
  mutate(change = (total / lag(total) - 1) * 100) %>% 
  filter(year(date) == 2014)

population_five_yr <- county_m %>% 
  filter(year(date) == 2011 | year(date) == 2016, month(date) == 1) %>%
  select(date, county, total) %>% 
  arrange(date) %>% 
  group_by(county, date) %>%
  mutate(total = sum(total)) %>% 
  unique() %>% 
  group_by(county) %>% 
  mutate(change = (total / lag(total) - 1) * 100) %>% 
  filter(year(date) == 2016)

population_five_yr[nrow(population_five_yr) + 1,] = list(as.Date("2016-01-01"), "Sierra County", 0, 0)

population_five_yr <- population_five_yr %>% 
  arrange(county)

realignment_population <- county_m %>% 
  filter(year(date) == 2011 & month(date) == 1) %>% 
  select(county, total) %>% 
  group_by(county) %>% 
  mutate(total = sum(total)) %>% 
  unique() %>% 
  rename(`2011_total` = total)

realignment_population$`2012_total` = population_one_yr$total
realignment_population$`2012_change` = population_one_yr$change
realignment_population$`2014_total` = population_three_yr$total
realignment_population$`2014_change` = population_three_yr$change
realignment_population$`2016_total` = population_five_yr$total
realignment_population$`2016_change` = population_five_yr$change

quantile(realignment_population$`2012_change`, c(0.25, 0.5, 0.75))
quantile(realignment_population$`2014_change`, c(0.25, 0.5, 0.75))
quantile(realignment_population$`2016_change`, c(0.25, 0.5, 0.75))

realignment_population %>% 
  filter(`2012_change` < -4.368030 | `2014_change` <  4.295704 | `2014_change` < -6.459330)
realignment_population %>% 
  filter(`2012_change` < -4.368030 & `2014_change` <  4.295704 & `2014_change` < -6.459330)

realignment_population %>% 
  filter(`2012_change` > 8.823529 | `2014_change` > 24.584718 | `2016_change` > 19.323671)
realignment_population %>% 
  filter(`2012_change` > 8.823529 & `2014_change` > 24.584718 & `2016_change` > 19.323671)

# county_m %>% 
#   mutate(year = year(date)) %>% 
#   select(year, county, total) %>% 
#   group_by(county, year) %>% 
#   mutate(total = sum(total)) %>% 
#   unique() %>% 
#   group_by(county) %>% 
#   arrange(year, .by_group = TRUE) %>% 
#   mutate(percent_change = (total / lag(total) - 1) * 100) %>% 
#   filter(year > 2010 & year != 2020 & is.finite(total) & percent_change > 20) %>% 
#   arrange(year)

county_m %>% 
  mutate(year = year(date)) %>% 
  select(year, county, unsen_male, unsen_female, sen_male, sen_female, total) %>%
  group_by(year, county) %>% 
  mutate(unsen_male = sum(unsen_male), unsen_female = sum(unsen_female), sen_male = sum(sen_male), 
         sen_female = sum(sen_female), total = sum(total)) %>% 
  unique() %>% 
  arrange(year)
```

```{r population_modeling}
total_model <- lm(total~factor(county) + date, data = population)
summary(total_model)
unsen_male_model <- lm(unsen_male~factor(county) + date, data = population)
summary(unsen_male_model)
unsen_female_model <- lm(unsen_female~factor(county) + date, data = population)
summary(unsen_female_model)
sen_male_model <- lm(sen_male~factor(county) + date, data = population)
summary(sen_male_model)
sen_female_model <- lm(sen_female~factor(county) + date, data = population)
summary(sen_female_model)
```

```{r population_viz}
county_m %>% 
  # filter(county == "Alameda County") %>% 
  select(date, unsen_male, unsen_female, sen_male, sen_female, total) %>% 
  group_by(date) %>% 
  mutate(unsen_male = sum(unsen_male), unsen_female = sum(unsen_female),
         sen_male = sum(sen_male), sen_female = sum(sen_female), total = sum(total)) %>% 
  unique() %>% 
  arrange(date) %>% 
  ggplot(data = ., mapping = aes(x = date, group = 1)) +
  geom_line(mapping = aes(y = sen_male, color = "male", linetype = "solid")) +
  geom_line(mapping = aes(y = sen_female, color = "female", linetype = "solid")) +
  geom_line(mapping = aes(y = unsen_male, color = "male", linetype = "dotted")) +
  geom_line(mapping = aes(y = unsen_female, color = "female", linetype = "dotted")) +
  labs(x = "Year", y = "Average Daily Populations") +
  scale_color_discrete(name = "Gender", breaks = c("male", "female"), labels = c("Male", "Female")) +
  scale_linetype_manual(name = "Sentence Type",
                        values = c("solid", "dotted"), labels = c("Sentenced", "Unsentenced")) +
  theme_classic() +
  theme(axis.text.x = element_text(color = "#000000", size = 10),
        axis.text.y = element_text(color = "#000000", size = 10))
```

# Length of Stay

```{r length_of_stay_data}
length_of_stay <- county_q %>% 
  filter(year > 2001) %>% 
  select(county, date, pretrial_release, sentenced_release) %>% 
  # group_by(county, date) %>%
  na.omit() %>% 
  # mutate(pretrial_release = mean(pretrial_release), sentenced_release = mean(sentenced_release)) %>% 
  arrange(date)
```

```{r length_of_stay_analysis}
county_q %>% 
  filter(year > 2001) %>% 
  group_by(county) %>%  
  count(is.na(pretrial_release)) %>% 
  mutate(proportion = n / sum(n)) %>% 
  filter(`is.na(pretrial_release)`) %>% 
  arrange(county) %>% 
  filter(proportion < 0.1)

county_q %>% 
  filter(year > 2001) %>% 
  group_by(county) %>% 
  count(is.na(sentenced_release)) %>% 
  mutate(proportion = n / sum(n)) %>% 
  filter(`is.na(sentenced_release)`) %>% 
  arrange(county) %>% 
  filter(proportion < 0.1)

length_of_stay_no_filter <- length_of_stay %>% 
  group_by(date) %>% 
  mutate(pretrial_release = mean(pretrial_release), sentenced_release = mean(sentenced_release)) %>% 
  select(-county) %>% 
  unique()

length_of_stay_filter <- length_of_stay %>% 
  filter(county == "Colusa County" | county == "Del Norte County" | county == "Fresno County" |
           county == "Madera County" | county == "Mariposa County" | county == "Plumas County" |
           county == "Santa Barbara County" | county == "Siskiyou County") %>%
  group_by(date) %>% 
  mutate(pretrial_release = mean(pretrial_release), sentenced_release = mean(sentenced_release)) %>% 
  select(-county) %>% 
  unique()

median(length_of_stay_no_filter$pretrial_release - length_of_stay_filter$pretrial_release) # 4 day diff
median(length_of_stay_no_filter$sentenced_release - length_of_stay_filter$sentenced_release) # 15 day diff

length_of_stay_one_yr <- length_of_stay %>% 
  filter(county == "Colusa County" | county == "Fresno County" | county == "Mariposa County",
         year(date) == 2011 | year(date) == 2012, month(date) == 1) %>% 
  arrange(date) %>% 
  group_by(county) %>% 
  mutate(pretrial_change = (pretrial_release / lag(pretrial_release) - 1) * 100,
         sentenced_change = (sentenced_release / lag(sentenced_release) - 1) * 100) %>% 
  filter(year(date) == 2012)

length_of_stay_three_yr <- length_of_stay %>% 
  filter(county == "Colusa County" | county == "Fresno County" | county == "Mariposa County",
         year(date) == 2011 | year(date) == 2014, month(date) == 1) %>% 
  arrange(date) %>% 
  group_by(county) %>% 
  mutate(pretrial_change = (pretrial_release / lag(pretrial_release) - 1) * 100,
         sentenced_change = (sentenced_release / lag(sentenced_release) - 1) * 100) %>% 
  filter(year(date) == 2014)

length_of_stay_five_yr <- length_of_stay %>% 
  filter(county == "Colusa County" | county == "Fresno County" | county == "Mariposa County",
         year(date) == 2011 | year(date) == 2016, month(date) == 1) %>% 
  arrange(date) %>% 
  group_by(county) %>% 
  mutate(pretrial_change = (pretrial_release / lag(pretrial_release) - 1) * 100,
         sentenced_change = (sentenced_release / lag(sentenced_release) - 1) * 100) %>% 
  filter(year(date) == 2016)

realignment_length_of_stay <- length_of_stay %>% 
  filter(county == "Colusa County" | county == "Fresno County" | county == "Mariposa County",
         year(date) == 2011 & month(date) == 1) %>% 
  select(county, pretrial_release, sentenced_release) %>% 
  group_by(county) %>% 
  rename(`2011_pretrial` = pretrial_release, `2011_sentenced` = sentenced_release)

realignment_length_of_stay$`2012_pretrial` = length_of_stay_one_yr$pretrial_release
realignment_length_of_stay$`2012_pre_change` = length_of_stay_one_yr$pretrial_change
realignment_length_of_stay$`2012_sentenced` = length_of_stay_one_yr$sentenced_release
realignment_length_of_stay$`2012_sen_change` = length_of_stay_one_yr$sentenced_change

realignment_length_of_stay$`2014_pretrial` = length_of_stay_three_yr$pretrial_release
realignment_length_of_stay$`2014_pre_change` = length_of_stay_three_yr$pretrial_change
realignment_length_of_stay$`2014_sentenced` = length_of_stay_three_yr$sentenced_release
realignment_length_of_stay$`2014_sen_change` = length_of_stay_three_yr$sentenced_change

realignment_length_of_stay$`2016_pretrial` = length_of_stay_five_yr$pretrial_release
realignment_length_of_stay$`2016_pre_change` = length_of_stay_five_yr$pretrial_change
realignment_length_of_stay$`2016_sentenced` = length_of_stay_five_yr$sentenced_release
realignment_length_of_stay$`2016_sen_change` = length_of_stay_five_yr$sentenced_change

quantile(realignment_length_of_stay$`2012_pre_change`, c(0.25, 0.5, 0.75))
quantile(realignment_length_of_stay$`2012_sen_change`, c(0.25, 0.5, 0.75))
quantile(realignment_length_of_stay$`2014_pre_change`, c(0.25, 0.5, 0.75))
quantile(realignment_length_of_stay$`2014_sen_change`, c(0.25, 0.5, 0.75))
quantile(realignment_length_of_stay$`2016_pre_change`, c(0.25, 0.5, 0.75))
quantile(realignment_length_of_stay$`2016_sen_change`, c(0.25, 0.5, 0.75))
```

```{r length_of_stay_modeling}

```

```{r length_of_stay_viz}
length_of_stay %>% 
  # filter(county == "Colusa County" | county == "Del Norte County" | county == "Fresno County" |
  #          county == "Madera County" | county == "Mariposa County" | county == "Plumas County" |
  #          county == "Santa Barbara County" | county == "Siskiyou County") %>% 
  group_by(date) %>% 
  mutate(pretrial_release = mean(pretrial_release), sentenced_release = mean(sentenced_release)) %>% 
  unique() %>% 
  ggplot(data = ., mapping = aes(x = date, group = 1)) +
  geom_line(mapping = aes(y = pretrial_release, linetype = "solid")) +
  geom_line(mapping = aes(y = sentenced_release, linetype = "dotted")) +
  labs(x = "Year", y = "Average Lengths of Stay") +
  scale_linetype_manual(name = "Sentence Type",
                        values = c("solid", "dotted"), labels = c("Sentenced", "Pretrial")) +
  theme_classic() +
  theme(axis.text.x = element_text(color = "#000000", size = 10),
        axis.text.y = element_text(color = "#000000", size = 10))

county_q %>% 
  filter(year > 2001, county == "Los Angeles County" | county == "San Francisco County") %>% 
  select(county, date, pretrial_release, sentenced_release) %>% 
  mutate(county = case_when(county == "Los Angeles County" ~ "la", county == "San Francisco County" ~ "sf"),
         row = row_number()) %>% 
  pivot_wider(names_from = county, values_from = c(pretrial_release, sentenced_release)) %>% 
  select(-row) %>% 
  group_by(date) %>% 
  fill(everything(), .direction = "down") %>%
  fill(everything(), .direction = "up") %>% 
  unique() %>% 
  ggplot(data = ., mapping = aes(x = date, group = 1)) +
  geom_line(mapping = aes(y = pretrial_release_la, color = "la", linetype = "solid")) +
  geom_line(mapping = aes(y = pretrial_release_sf, color = "sf", linetype = "solid")) +
  geom_line(mapping = aes(y = sentenced_release_la, color = "la", linetype = "dotted")) +
  geom_line(mapping = aes(y = sentenced_release_sf, color = "sf", linetype = "dotted")) +
  labs(x = "Year", y = "Average Lengths of Stay") +
  scale_color_discrete(name = "County", breaks = c("la", "sf"), labels = c("Los Angeles", "San Francisco")) +
  scale_linetype_manual(name = "Sentence Type",
                        values = c("solid", "dotted"), labels = c("Sentenced", "Unsentenced")) +
  theme_classic() +
  theme(axis.text.x = element_text(color = "#000000", size = 10),
        axis.text.y = element_text(color = "#000000", size = 10))
```